on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

env:
  REGISTRY: ghcr.io
  NAMESPACE: charles0891
  IMAGE_NAME: kube-argocd-deploy
  PROJECT_VERSION: 0.0.1-SNAPSHOT
  DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  unit-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Restore Maven cache
        uses: skjolber/maven-cache-github-action@v1
        with:
          step: restore
      - name: Run Unit Tests
        # run: mvn --batch-mode --update-snapshots verify
        run: mvn test verify
      - name: Save Maven cache
        uses: skjolber/maven-cache-github-action@v1
        with:
          step: save
  build:
    needs: unit-test
    runs-on: ubuntu-latest
    outputs:
      project-version-output: ${{ steps.create-project-version.outputs.PROJECT_VERSION_OUTPUT }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - id: create-project-version
        run: |
          FULL_SHA=${{ github.sha }}
          SHORT_SHA=${FULL_SHA:0:7}
          echo "PROJECT_VERSION=${SHORT_SHA}-${{ github.run_number }}" >> "$GITHUB_ENV"
          echo "PROJECT_VERSION_OUTPUT=${SHORT_SHA}-${{ github.run_number }}" >> "$GITHUB_OUTPUT"

      - name: Restore Maven cache
        uses: skjolber/maven-cache-github-action@v1
        with:
          step: restore
      - name: Build with Maven
        run: ./mvnw package

      - name: Log in to the Container registry
        uses: docker/login-action@v3.1.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_PASS }}

      - name: Build Docker image
        run: docker build -f src/main/docker/Dockerfile.jvm -t ${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{env.PROJECT_VERSION}} .
#        run: |
#          docker buildx create --use
#          docker buildx inspect default --bootstrap
#          docker buildx build -f src/main/docker/Dockerfile.jvm -t ${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{env.PROJECT_VERSION}} --load .

      - name: Display Docker images
        run: docker image ls

      - name: Push to packages
        run: docker push ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{env.PROJECT_VERSION}}